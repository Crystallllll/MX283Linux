/*
 * iMX28 Boot Prep
 *
 * Copyright 2008-2010 Freescale Semiconductor
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
 */

#include "regsclkctrl.h"
#include "regsemi.h"
#include "regsdram.h"
#include "regspower.h"
#include "regsuartdbg.h"
#include "regspinctrl.h"
#include "regsdigctl.h"
#include "regsocotp.h"
#include <stdarg.h>

#define EMI_MAX_MEM_BK				(0x0000F100)
#define EMI_MAX_MEM_BK_ANOTHER		(0x0000F400)

typedef unsigned char uint8_t;
typedef unsigned short uint16_t;
typedef unsigned int uint32_t;

struct ddr2_information
{
    unsigned char header;
    unsigned char length;
    char ddr2_info[9];
};
struct ddr2_information ddr2_array =
{
    .header = 0xFE,
    .length = 4,
    .ddr2_info = "64M"
};

void delay(unsigned int us)
{
    unsigned int start , cur;
    start = cur = HW_DIGCTL_MICROSECONDS_RD();

    while (cur < start + us)
    {

        cur = HW_DIGCTL_MICROSECONDS_RD();
    }

}

volatile void *memcpy(volatile char *s1, const void *s2, int n)
{
    volatile char *dst = s1;
    const char *src = s2;

    while (n-- > 0)
        *dst++ = *src++;

    return s1;
}


int _start(int arg)
{
    const uint16_t dram_crc = 0xF19C;
    volatile unsigned int value;
    volatile unsigned int *DRAM_REG = (volatile unsigned int *) HW_DRAM_CTL00_ADDR;
	char *pMemlocation = (char *)EMI_MAX_MEM_BK;

    /* DUART 复用配置,否则接下来U-Boot怎么都没用. */
    HW_PINCTRL_MUXSEL6_CLR(0xF0);
    HW_PINCTRL_MUXSEL6_SET(0xA0);

    /* 设置为DDR 模式 */
    HW_PINCTRL_EMI_DS_CTRL_SET(BW_PINCTRL_EMI_DS_CTRL_DDR_MODE(0x3));

    /* PLL模块上电 */
    HW_CLKCTRL_PLL0CTRL0_SET(BM_CLKCTRL_PLL0CTRL0_POWER);
    delay(11000);

    /* 初始化EMI引脚 */
    HW_PINCTRL_MUXSEL10_CLR(
        BM_PINCTRL_MUXSEL10_BANK5_PIN00 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN01 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN02 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN03 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN04 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN05 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN06 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN07 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN08 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN09 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN10 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN11 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN12 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN13 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN14 |
        BM_PINCTRL_MUXSEL10_BANK5_PIN15);

    HW_PINCTRL_MUXSEL11_CLR(
        BM_PINCTRL_MUXSEL11_BANK5_PIN16 |
        BM_PINCTRL_MUXSEL11_BANK5_PIN17 |
        BM_PINCTRL_MUXSEL11_BANK5_PIN18 |
        BM_PINCTRL_MUXSEL11_BANK5_PIN19 |
        BM_PINCTRL_MUXSEL11_BANK5_PIN20 |
        BM_PINCTRL_MUXSEL11_BANK5_PIN21 |
        BM_PINCTRL_MUXSEL11_BANK5_PIN22 |
        BM_PINCTRL_MUXSEL11_BANK5_PIN23 |
        BM_PINCTRL_MUXSEL11_BANK5_PIN26 );

    HW_PINCTRL_MUXSEL12_CLR(
        BM_PINCTRL_MUXSEL12_BANK6_PIN00 |
        BM_PINCTRL_MUXSEL12_BANK6_PIN01 |
        BM_PINCTRL_MUXSEL12_BANK6_PIN02 |
        BM_PINCTRL_MUXSEL12_BANK6_PIN03 |
        BM_PINCTRL_MUXSEL12_BANK6_PIN04 |
        BM_PINCTRL_MUXSEL12_BANK6_PIN05 |
        BM_PINCTRL_MUXSEL12_BANK6_PIN06 |
        BM_PINCTRL_MUXSEL12_BANK6_PIN07 |
        BM_PINCTRL_MUXSEL12_BANK6_PIN08 |
        BM_PINCTRL_MUXSEL12_BANK6_PIN09 |
        BM_PINCTRL_MUXSEL12_BANK6_PIN10 |
        BM_PINCTRL_MUXSEL12_BANK6_PIN11 |
        BM_PINCTRL_MUXSEL12_BANK6_PIN12 |
        BM_PINCTRL_MUXSEL12_BANK6_PIN13 |
        BM_PINCTRL_MUXSEL12_BANK6_PIN14 );

    HW_PINCTRL_MUXSEL13_CLR(
        BM_PINCTRL_MUXSEL13_BANK6_PIN16 |
        BM_PINCTRL_MUXSEL13_BANK6_PIN17 |
        BM_PINCTRL_MUXSEL13_BANK6_PIN18 |
        BM_PINCTRL_MUXSEL13_BANK6_PIN19 |
        BM_PINCTRL_MUXSEL13_BANK6_PIN20 |
        BM_PINCTRL_MUXSEL13_BANK6_PIN21 |
        BM_PINCTRL_MUXSEL13_BANK6_PIN22 |
        BM_PINCTRL_MUXSEL13_BANK6_PIN23 |
        BM_PINCTRL_MUXSEL13_BANK6_PIN24 );

    /* 初始化时钟 */
    HW_CLKCTRL_FRAC0_SET(BM_CLKCTRL_FRAC0_CLKGATEEMI);
    /* 设置EMI分频 */
    HW_CLKCTRL_FRAC0_SET(BM_CLKCTRL_FRAC0_EMIFRAC);
    HW_CLKCTRL_FRAC0_CLR(BF_CLKCTRL_FRAC0_EMIFRAC(~21));
    /* 使能EMI时钟 */
    HW_CLKCTRL_FRAC0_CLR(BM_CLKCTRL_FRAC0_CLKGATEEMI);
    delay(10000);
    /* 选择EMI时钟 */
    HW_CLKCTRL_EMI_WR(BF_CLKCTRL_EMI_DIV_XTAL(1) |
                      BF_CLKCTRL_EMI_DIV_EMI(2)
                     );
    HW_CLKCTRL_CLKSEQ_CLR(BM_CLKCTRL_CLKSEQ_BYPASS_EMI);
    delay(10000);

    /* 使能VDDA */
    value = HW_POWER_VDDACTRL_RD();
    value &= ~BM_POWER_VDDACTRL_TRG;
    value |= BF_POWER_VDDACTRL_TRG(0xC);
    value &= ~BM_POWER_VDDACTRL_BO_OFFSET;
    value |= BF_POWER_VDDACTRL_BO_OFFSET(6);
    value &= ~BM_POWER_VDDACTRL_LINREG_OFFSET;
    value |= BF_POWER_VDDACTRL_LINREG_OFFSET(2);
    HW_POWER_VDDACTRL_WR(value);

    /* 配置DRAM时序 */

    value = HW_DRAM_CTL16_RD();
    value &= ~BM_DRAM_CTL16_START;
    HW_DRAM_CTL16_WR(value);

    /* 配置DRAM寄存器 */
    DRAM_REG[0] =  0x00000000 ; //00000000000000000000000000000000 user_def_reg_0(RW)
    DRAM_REG[1] =  0x00000000 ; //00000000000000000000000000000000 user_def_reg_1(RW)
    DRAM_REG[2] =  0x00000000 ; //00000000000000000000000000000000 user_def_reg_2(RW)
    DRAM_REG[3] =  0x00000000 ; //00000000000000000000000000000000 user_def_reg_3(RW)
    DRAM_REG[4] =  0x00000000 ; //00000000000000000000000000000000 user_def_reg_4(RW)
    DRAM_REG[5] =  0x00000000 ; //00000000000000000000000000000000 user_def_reg_5(RW)
    DRAM_REG[6] =  0x00000000 ; //00000000000000000000000000000000 user_def_reg_6(RW)
    DRAM_REG[7] =  0x00000000 ; //00000000000000000000000000000000 user_def_reg_7(RW)
    DRAM_REG[8] =  0x00000000 ; //00000000000000000000000000000000 user_def_reg_ro_0(RD)
    DRAM_REG[9] =  0x00000000 ; //00000000000000000000000000000000 user_def_reg_ro_1(RD)
    DRAM_REG[10] = 0x00000000 ; //00000000000000000000000000000000 user_def_reg_ro_2(RD)
    DRAM_REG[11] = 0x00000000 ; //00000000000000000000000000000000 user_def_reg_ro_3(RD)
    DRAM_REG[12] = 0x00000000 ; //00000000000000000000000000000000 user_def_reg_ro_4(RD)
    DRAM_REG[13] = 0x00000000 ; //00000000000000000000000000000000 user_def_reg_ro_5(RD)
    DRAM_REG[14] = 0x00000000 ; //00000000000000000000000000000000 user_def_reg_ro_6(RD)
    DRAM_REG[15] = 0x00000000 ; //00000000000000000000000000000000 user_def_reg_ro_7(RD)
    DRAM_REG[16] = 0x00000000 ; //0000000_0 write_modereg(WR) 0000000_0 power_down(RW) 000000000000000_0 start(RW)
    DRAM_REG[17] = 0x00000100 ; //0000000_0 auto_refresh_mode(RW) 0000000_0 arefresh(WR) 0000000_1 enable_quick_srefresh(RW) 0000000_0 srefresh(RW+)
    DRAM_REG[18] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[19] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[20] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[21] = 0x00000000 ; //00000_000 cke_delay(RW) 00000000 dll_lock(RD) 0000000_0 dlllockreg(RD) 0000000_0 dll_bypass_mode(RW)
    DRAM_REG[22] = 0x00000000 ; //000000000000_0000 lowpower_refresh_enable(RW) 000_00000 lowpower_control(RW) 000_00000 lowpower_auto_enable(RW)
    DRAM_REG[23] = 0x00000000 ; //0000000000000000 lowpower_internal_cnt(RW) 0000000000000000 lowpower_external_cnt(RW)
    DRAM_REG[24] = 0x00000000 ; //0000000000000000 lowpower_self_refresh_cnt(RW) 0000000000000000 lowpower_refresh_hold(RW)
    DRAM_REG[25] = 0x00000000 ; //00000000000000000000000000000000 lowpower_power_down_cnt(RW)
    DRAM_REG[26] = 0x00010101 ; //000000000000000_1 priority_en(RW) 0000000_1 addr_cmp_en(RW) 0000000_1 placement_en(RW)
    DRAM_REG[27] = 0x01010101 ; //0000000_1 swap_port_rw_same_en(RW) 0000000_1 swap_en(RW) 0000000_1 bank_split_en(RW) 0000000_1 rw_same_en(RW)
    DRAM_REG[28] = 0x000f0f01 ; //00000_000 q_fullness(RW) 0000_1111 age_count(RW) 0000_1111 command_age_count(RW) 0000000_1 active_aging(RW)
    DRAM_REG[29] = 0x0f02020a ; //0000_1111 cs_map(RW) 00000_010 column_size(RW) 00000_010 addr_pins(RW) 0000_1010 aprebit(RW)
    DRAM_REG[30] = 0x00000000 ; //0000000000000_000 max_cs_reg(RD) 0000_0000 max_row_reg(RD) 0000_0000 max_col_reg(RD)
    DRAM_REG[31] = 0x00000101 ; //000000000000000_1 eight_bank_mode(RW) 0000000_1 drive_dq_dqs(RW) 0000000_1 dqs_n_en(RW)
    DRAM_REG[32] = 0x00000100 ; //00000000000000000000000_1 reduc(RW) 0000000_0 reg_dimm_enable(RW)
    DRAM_REG[33] = 0x00000100 ; //00000000000000000000000_1 concurrentap(RW) 0000000_0 ap(RW)
    DRAM_REG[34] = 0x00000000 ; //0000000_0 writeinterp(RW) 0000000_0 intrptwritea(RW) 0000000_0 intrptreada(RW) 0000000_0 intrptapburst(RW)
    DRAM_REG[35] = 0x00000002 ; //000000000000000_0 pwrup_srefresh_exit(RW) 0000000_0 no_cmd_init(RW) 0000_0010 initaref(RW)
    DRAM_REG[36] = 0x01010000 ; //0000000_1 tref_enable(RW) 0000000_1 tras_lockout(RW) 000000000000000_0 fast_write(RW)
    DRAM_REG[37] = 0x07080403 ; //0000_0111 caslat_lin_gate(RW) 0000_1000 caslat_lin(RW) 00000_100 caslat(RW) 0000_0011 wrlat(RW)
    DRAM_REG[38] = 0x06005003 ; //000_00110 tdal(RW) 0000000001010000 tcpd(RW) 00000_011 tcke(RW)
    DRAM_REG[39] = 0x0a0000c8 ; //00_001010 tfaw(RW) 000000000000000011001000 tdll(RW)
    DRAM_REG[40] = 0x02009c40 ; //000_00010 tmrd(RW) 000000000111010100100010 tinit(RW)
    DRAM_REG[41] = 0x0002030c ; //0000000000000010 tpdex(RW) 00000011 trcd_int(RW) 00_001100 trc(RW)
    DRAM_REG[42] = 0x0036a609 ; //000000000011011010100110 tras_max(RW) 00001001 tras_min(RW)
    DRAM_REG[43] = 0x031a0612 ; //0000_0011 trp(RW) 00011010 trfc(RW) 00_00011000010010 tref(RW)
    DRAM_REG[44] = 0x02030202 ; //0000_0010 twtr(RW) 000_00011 twr_int(RW) 00000_010 trtp(RW) 00000_010 trrd(RW)
    DRAM_REG[45] = 0x00c8001c ; //0000000011001000 txsr(RW) 0000000000011100 txsnr(RW)
    DRAM_REG[46] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[47] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[48] = 0x00012100 ; //0_0000000 axi0_current_bdw(RD) 0000000_1 axi0_bdw_ovflow(RW) 0_0100001 axi0_bdw(RW) 000000_00 axi0_fifo_type_reg(RW)
    DRAM_REG[49] = 0xffff0303 ; //0101010101010101 axi0_en_size_lt_width_instr(RW) 00000_011 axi0_w_priority(RW) 00000_011 axi0_r_priority(RW)
    DRAM_REG[50] = 0x00012100 ; //0_0000000 axi1_current_bdw(RD) 0000000_1 axi1_bdw_ovflow(RW) 0_0100001 axi1_bdw(RW) 000000_00 axi1_fifo_type_reg(RW)
    DRAM_REG[51] = 0xffff0303 ; //1111111100000000 axi1_en_size_lt_width_instr(RW) 00000_011 axi1_w_priority(RW) 00000_011 axi1_r_priority(RW)
    DRAM_REG[52] = 0x00012100 ; //0_0000000 axi2_current_bdw(RD) 0000000_1 axi2_bdw_ovflow(RW) 0_0100001 axi2_bdw(RW) 000000_00 axi2_fifo_type_reg(RW)
    DRAM_REG[53] = 0xffff0303 ; //0000000000000001 axi2_en_size_lt_width_instr(RW) 00000_011 axi2_w_priority(RW) 00000_011 axi2_r_priority(RW)
    DRAM_REG[54] = 0x00012100 ; //0_0000000 axi3_current_bdw(RD) 0000000_1 axi3_bdw_ovflow(RW) 0_0100001 axi3_bdw(RW) 000000_00 axi3_fifo_type_reg(RW)
    DRAM_REG[55] = 0xffff0303 ; //0000000000000001 axi3_en_size_lt_width_instr(RW) 00000_011 axi3_w_priority(RW) 00000_011 axi3_r_priority(RW)
    DRAM_REG[56] = 0x00000003 ; //00000000000000000000000000000_011 arb_cmd_q_threshold(RW)
    DRAM_REG[57] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[58] = 0x00000000 ; //00000_00000000000 int_status(RD) 00000_00000000000 int_mask(RW)
    DRAM_REG[59] = 0x00000000 ; //00000000000000000000000000000000 out_of_range_addr(RD)
    DRAM_REG[60] = 0x00000000 ; //000000000000000000000000000000_00
    DRAM_REG[61] = 0x00000000 ; //00_000000 out_of_range_type(RD) 0_0000000 out_of_range_length(RD) 000_0000000000000 out_of_range_source_id(RD)
    DRAM_REG[62] = 0x00000000 ; //00000000000000000000000000000000 port_cmd_error_addr(RD)
    DRAM_REG[63] = 0x00000000 ; //000000000000000000000000000000_00
    DRAM_REG[64] = 0x00000000 ; //00000000000_0000000000000 port_cmd_error_id(RD) 0000_0000 port_cmd_error_type(RD)
    DRAM_REG[65] = 0x00000000 ; //00000000000_0000000000000 port_data_error_id(RD) 00000_000 port_data_error_type(RD)
    DRAM_REG[66] = 0x00000612 ; //000000000000_0000 tdfi_ctrlupd_min(RD) 00_00011000010010 tdfi_ctrlupd_max(RW)
    DRAM_REG[67] = 0x01000f02 ; //0000_0001 tdfi_dram_clk_enable(RW) 00000_000 tdfi_dram_clk_disable(RW) 0000_0000 dram_clk_disable(RW) 0000_0010 tdfi_ctrl_delay(RW)
    DRAM_REG[68] = 0x06120612 ; //00_00011000010010 tdfi_phyupd_type0(RW) 00_00011000010010 tdfi_phyupd_resp(RW)
    DRAM_REG[69] = 0x00000200 ; //00000000000000000000_0010 tdfi_phy_wrlat_base(RW) 0000_0000 tdfi_phy_wrlat(RD)
    DRAM_REG[70] = 0x00020007 ; //000000000000_0010 tdfi_rddata_en_base(RW) 0000_0000 tdfi_rddata_en(RD) 0000_0111 tdfi_phy_rdlat(RW)
    DRAM_REG[71] = 0xf4004a27;
    DRAM_REG[72] = 0xf4004a27;
    DRAM_REG[73] = 0xf4004a27;
    DRAM_REG[74] = 0xf4004a27;
    DRAM_REG[75] = 0x07000300 ; //00000111000000000000001100000000 phy_ctrl_reg_1_0(RW)
    DRAM_REG[76] = 0x07000300 ; //00000111000000000000001100000000 phy_ctrl_reg_1_1(RW)
    DRAM_REG[77] = 0x07400300 ; //00000111010000000000001100000000 phy_ctrl_reg_1_2(RW)
    DRAM_REG[78] = 0x07400300 ; //00000111010000000000001100000000 phy_ctrl_reg_1_3(RW)
    DRAM_REG[79] = 0x00000005 ; //00000000000000000000000000000101 phy_ctrl_reg_2(RW)
    DRAM_REG[80] = 0x00000000 ; //00000000000000000000000000000000 dft_ctrl_reg(RW)
    DRAM_REG[81] = 0x00000000 ; //0000000000000000000_00000 ocd_adjust_pup_cs_0(RW) 000_00000 ocd_adjust_pdn_cs_0(RW)
    DRAM_REG[82] = 0x01000000 ; //0000000_1 odt_alt_en(RW) 000000000000000000000000
    DRAM_REG[83] = 0x01020408 ; //0000_0001 odt_rd_map_cs3(RW) 0000_0010 odt_rd_map_cs2(RW) 0000_0100 odt_rd_map_cs1(RW) 0000_1000 odt_rd_map_cs0(RW)
    DRAM_REG[84] = 0x08040201 ; //0000_1000 odt_wr_map_cs3(RW) 0000_0100 odt_wr_map_cs2(RW) 0000_0010 odt_wr_map_cs1(RW) 0000_0001 odt_wr_map_cs0(RW)
    DRAM_REG[85] = 0x000f1133 ; //00000000000011110001000100110011 pad_ctrl_reg_0(RW)
    DRAM_REG[86] = 0x00000000 ; //00000000000000000000000000000000 version(RD)
    DRAM_REG[87] = 0x00001f04;
    DRAM_REG[88] = 0x00001f04;
    DRAM_REG[89] = 0x00001f04;
    DRAM_REG[90] = 0x00001f04;
    DRAM_REG[91] = 0x00001f04;
    DRAM_REG[92] = 0x00001f04;
    DRAM_REG[93] = 0x00001f04;
    DRAM_REG[94] = 0x00001f04;
    DRAM_REG[95] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_0_0(RD)
    DRAM_REG[96] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_0_1(RD)
    DRAM_REG[97] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_0_2(RD)
    DRAM_REG[98] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_0_3(RD)
    DRAM_REG[99] = 0x00000000 ; //00000000000000000000000000000000 phy_obs_reg_0_0(RD)
    DRAM_REG[100] = 0x00000000 ; //00000000000000000000000000000000 phy_obs_reg_0_1(RD)
    DRAM_REG[101] = 0x00000000 ; //00000000000000000000000000000000 phy_obs_reg_0_2(RD)
    DRAM_REG[102] = 0x00000000 ; //00000000000000000000000000000000 phy_obs_reg_0_3(RD)
    DRAM_REG[103] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_1_0(RD)
    DRAM_REG[104] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[105] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[106] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[107] = 0x00000000 ; //00000000000000000000000_000000000
    DRAM_REG[108] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_1_1(RD)
    DRAM_REG[109] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[110] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[111] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[112] = 0x00000000 ; //00000000000000000000000_000000000
    DRAM_REG[113] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_1_2(RD)
    DRAM_REG[114] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[115] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[116] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[117] = 0x00000000 ; //00000000000000000000000_000000000
    DRAM_REG[118] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_1_3(RD)
    DRAM_REG[119] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[120] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[121] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[122] = 0x00000000 ; //00000000000000000000000_000000000
    DRAM_REG[123] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_2_0(RD)
    DRAM_REG[124] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[125] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[126] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[127] = 0x00000000 ; //00000000000000000000000_000000000
    DRAM_REG[128] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_2_1(RD)
    DRAM_REG[129] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[130] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[131] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[132] = 0x00000000 ; //00000000000000000000000_000000000
    DRAM_REG[133] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_2_2(RD)
    DRAM_REG[134] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[135] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[136] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[137] = 0x00000000 ; //00000000000000000000000_000000000
    DRAM_REG[138] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_2_3(RD)
    DRAM_REG[139] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[140] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[141] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[142] = 0x00000000 ; //00000000000000000000000_000000000
    DRAM_REG[143] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_3_0(RD)
    DRAM_REG[144] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[145] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[146] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[147] = 0x00000000 ; //00000000000000000000000_000000000
    DRAM_REG[148] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_3_1(RD)
    DRAM_REG[149] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[150] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[151] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[152] = 0x00000000 ; //00000000000000000000000_000000000
    DRAM_REG[153] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_3_2(RD)
    DRAM_REG[154] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[155] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[156] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[157] = 0x00000000 ; //00000000000000000000000_000000000
    DRAM_REG[158] = 0x00000000 ; //00000000000000000000000000000000 dll_obs_reg_3_3(RD)
    DRAM_REG[159] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[160] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[161] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[162] = 0x00010000 ; //00000_000 w2r_samecs_dly(RW) 00000_001 w2r_diffcs_dly(RW) 0000000_000000000
    DRAM_REG[163] = 0x00030404 ; //00000000 dll_rst_adj_dly(RW) 0000_0011 wrlat_adj(RW) 0000_0100 rdlat_adj(RW) 0000_0100 dram_class(RW)
    DRAM_REG[164] = 0x00000003 ; //00000000000000_0000000000 int_ack(WR) 00000011 tmod(RW)
    DRAM_REG[165] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[166] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[167] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[168] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[169] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[170] = 0x00000000 ; //00000000000000000000000000000000
    DRAM_REG[171] = 0x01010000 ; //0000000_1 axi5_bdw_ovflow(RW) 0000000_1 axi4_bdw_ovflow(RW) 0000000000000000 dll_rst_delay(RW)
    DRAM_REG[172] = 0x01000000 ; //0000000_1 resync_dll_per_aref_en(RW) 0000000_0 resync_dll(WR) 0000000_0 concurrentap_wr_only(RW) 0000000_0 cke_status(RD)
    DRAM_REG[173] = 0x03030000 ; //00000_011 axi4_w_priority(RW) 00000_011 axi4_r_priority(RW) 000000_00 axi5_fifo_type_reg(RW) 000000_00 axi4_fifo_type_reg(RW)
    DRAM_REG[174] = 0x00010303 ; //00000_000 r2r_samecs_dly(RW) 00000_001 r2r_diffcs_dly(RW) 00000_011 axi5_w_priority(RW) 00000_011 axi5_r_priority(RW)
    DRAM_REG[175] = 0x01020202 ; //00000_001 w2w_diffcs_dly(RW) 00000_010 tbst_int_interval(RW) 00000_010 r2w_samecs_dly(RW) 00000_010 r2w_diffcs_dly(RW)
    DRAM_REG[176] = 0x00000000 ; //0000_0000 add_odt_clk_sametype_diffcs(RW) 0000_0000 add_odt_clk_difftype_samecs(RW) 0000_0000 add_odt_clk_difftype_diffcs(RW) 00000_000 w2w_samecs_dly(RW)
    DRAM_REG[177] = 0x02040303 ; //000_00010 tccd(RW) 0000_0100 trp_ab(RW) 0000_0011 cksrx(RW) 0000_0011 cksre(RW)
    DRAM_REG[178] = 0x21002103 ; //0_0100001 axi5_bdw(RW) 0_0000000 axi4_current_bdw(RD) 0_0100001 axi4_bdw(RW) 000_00011 tckesr(RW)
    DRAM_REG[179] = 0x00061200 ; //0000000000_00011000010010 tdfi_phyupd_type1(RW) 0_0000000 axi5_current_bdw(RD)
    DRAM_REG[180] = 0x06120612 ; //00_00011000010010 tdfi_phyupd_type3(RW) 00_00011000010010 tdfi_phyupd_type2(RW)
    DRAM_REG[181] = 0x04420442 ; //0_000010001000010 mr0_data_1(RW) 0_000010001000010 mr0_data_0(RW)
    DRAM_REG[182] = 0x04420442 ; //0_000010001000010 mr0_data_3(RW) 0_000010001000010 mr0_data_2(RW)
    DRAM_REG[183] = 0x00040004 ; //0_000000000000100 mr1_data_1(RW) 0_000000000000100 mr1_data_0(RW)
    DRAM_REG[184] = 0x00040004 ; //0_000000000000100 mr1_data_3(RW) 0_000000000000100 mr1_data_2(RW)
    DRAM_REG[185] = 0x00000000 ; //0_000000000000000 mr2_data_1(RW) 0_000000000000000 mr2_data_0(RW)
    DRAM_REG[186] = 0x00000000 ; //0_000000000000000 mr2_data_3(RW) 0_000000000000000 mr2_data_2(RW)
    DRAM_REG[187] = 0x00000000 ; //0_000000000000000 mr3_data_1(RW) 0_000000000000000 mr3_data_0(RW)
    DRAM_REG[188] = 0x00000000 ; //0_000000000000000 mr3_data_3(RW) 0_000000000000000 mr3_data_2(RW)
    DRAM_REG[189] = 0xffffffff ; //0000000000000001 axi5_en_size_lt_width_instr(RW) 0000000000000001 axi4_en_size_lt_width_instr(RW)

    /* 配置DRAM刷新时序 */
    value = HW_DRAM_CTL17_RD();
    value &= ~BM_DRAM_CTL17_SREFRESH;
    HW_DRAM_CTL17_WR(value);

    value = HW_DRAM_CTL16_RD();
    value |= BM_DRAM_CTL16_START;
    HW_DRAM_CTL16_WR(value);

    while(!(HW_DRAM_CTL58_RD() & 0x100000));

    /* 配置DRAM信息(计算CRC) */
    memcpy (pMemlocation, &ddr2_array, ddr2_array.length + 2);
    pMemlocation += ddr2_array.length + 2;
    *pMemlocation++ = dram_crc >> 8;
    *pMemlocation++ = dram_crc & 0xff;
    pMemlocation = (char *)EMI_MAX_MEM_BK_ANOTHER;

    /* 提升CPU时钟 */
    value = HW_POWER_VDDDCTRL_RD();

    value &= ~BM_POWER_VDDDCTRL_TRG;
    value |= BF_POWER_VDDDCTRL_TRG(28);
    value &= ~BM_POWER_VDDDCTRL_BO_OFFSET;
    value |= BF_POWER_VDDDCTRL_BO_OFFSET(7);
    value &= ~BM_POWER_VDDDCTRL_LINREG_OFFSET;
    value |= BF_POWER_VDDDCTRL_LINREG_OFFSET(2);

    /* 调整内核电压到1.5V. */
    HW_POWER_VDDDCTRL_WR(value);

    delay(10000);

    value = HW_CLKCTRL_FRAC0_RD();
    value &= ~BM_CLKCTRL_FRAC0_CPUFRAC;
    value |= BF_CLKCTRL_FRAC0_CPUFRAC(19);
    value &= ~BM_CLKCTRL_FRAC0_CLKGATECPU;

    HW_CLKCTRL_FRAC0_WR(value); /* 454MHz 主频 */

    HW_CLKCTRL_CLKSEQ_SET(BM_CLKCTRL_CLKSEQ_BYPASS_CPU);

    HW_CLKCTRL_HBUS_SET(BM_CLKCTRL_HBUS_DIV);
    HW_CLKCTRL_HBUS_CLR(((~3)&BM_CLKCTRL_HBUS_DIV));

    delay(10000);

    value = HW_CLKCTRL_CPU_RD();
    value &= ~BM_CLKCTRL_CPU_DIV_CPU;
    value |= 1;
    HW_CLKCTRL_CPU_WR(value);

    HW_CLKCTRL_CLKSEQ_CLR(BM_CLKCTRL_CLKSEQ_BYPASS_CPU);


    return 0;
}

/* kiss gcc's ass to make it happy */
void __aeabi_unwind_cpp_pr0() {}
void __aeabi_unwind_cpp_pr1() {}

